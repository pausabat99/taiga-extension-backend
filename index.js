require('dotenv').config();

const cron = require('node-cron');
const express = require('express');
const session = require('express-session');
const cors = require('cors');
const passport = require("passport");
const bodyParser = require('body-parser');
const http = require('http');
require('./auth');

const app = express();

app.use(session({
    name : 'mycookie',
    secret : process.env.SECRET,
    saveUninitialized : false,
    resave : true
}));

app.use(passport.initialize());
app.use(passport.session());
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(cors());

app.set('views', __dirname + '/views');
app.engine('html', require('ejs').renderFile);
app.set('view engine', 'ejs');

//VARIABLE
var metrics = [{"id":"acceptance_criteria_check","name":"Acceptance Criteria Application","description":"Percentage of user stories with acceptance criteria with respect to the total number of user stories in this sprint","value":0.0,"value_description":"0.00","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {UserStoriesWithAC=0, UserStoriesTotal=44}\nformula: UserStoriesWithAC / UserStoriesTotal\nvalue: 0.0","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["userstoriesdefinitionquality"]},{"id":"assignedtasks_Akram_T","name":"Akram_T tasks","description":"Percentage of tasks made by a student with respect to the total number of tasks in the project","value":0.060869563,"value_description":"0.06","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssignee=7, tasksTotal=115}\nformula: tasksAssignee / tasksTotal\nvalue: 0.06086956521739131","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["assignedtasks","taskscontribution"]},{"id":"assignedtasks_gerardalvarez","name":"gerardalvarez tasks","description":"Percentage of tasks made by a student with respect to the total number of tasks in the project","value":0.24347825,"value_description":"0.24","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssignee=28, tasksTotal=115}\nformula: tasksAssignee / tasksTotal\nvalue: 0.24347826086956523","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["assignedtasks","taskscontribution"]},{"id":"assignedtasks_mariacloehb","name":"mariacloehb tasks","description":"Percentage of tasks made by a student with respect to the total number of tasks in the project","value":0.07826087,"value_description":"0.08","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssignee=9, tasksTotal=115}\nformula: tasksAssignee / tasksTotal\nvalue: 0.0782608695652174","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["assignedtasks","taskscontribution"]},{"id":"assignedtasks_oriolcuellar","name":"oriolcuellar tasks","description":"Percentage of tasks made by a student with respect to the total number of tasks in the project","value":0.20869565,"value_description":"0.21","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssignee=24, tasksTotal=115}\nformula: tasksAssignee / tasksTotal\nvalue: 0.20869565217391303","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["assignedtasks","taskscontribution"]},{"id":"assignedtasks_pablomartinez34","name":"pablomartinez34 tasks","description":"Percentage of tasks made by a student with respect to the total number of tasks in the project","value":0.17391305,"value_description":"0.17","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssignee=20, tasksTotal=115}\nformula: tasksAssignee / tasksTotal\nvalue: 0.17391304347826086","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["assignedtasks","taskscontribution"]},{"id":"assignedtasks_sergicasau","name":"sergicasau tasks","description":"Percentage of tasks made by a student with respect to the total number of tasks in the project","value":0.069565214,"value_description":"0.07","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssignee=8, tasksTotal=115}\nformula: tasksAssignee / tasksTotal\nvalue: 0.06956521739130435","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["assignedtasks","taskscontribution"]},{"id":"closed_tasks_with_AE","name":"Closed Tasks with Actual Effort Information","description":"Percentage of closed tasks with actual effort information added with respect to the total number of closed tasks in this sprint","value":0.0,"value_description":"0.00","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {closedTasksTotal=39, closedTasksWithActualEffort=0}\nformula: closedTasksWithActualEffort / closedTasksTotal\nvalue: 0.0","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["taskseffortinformation"]},{"id":"closedtasks_Akram_T","name":"Akram_T closed tasks","description":"Percentage of closed tasks made by a student with respect to the total number of tasks assigned to student","value":0.71428573,"value_description":"0.71","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssigneeTotal=7, closedTasksAssignee=5}\nformula: closedTasksAssignee / tasksAssigneeTotal\nvalue: 0.7142857142857143","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["closedtasks","fulfillmentoftasks"]},{"id":"closedtasks_gerardalvarez","name":"gerardalvarez closed tasks","description":"Percentage of closed tasks made by a student with respect to the total number of tasks assigned to student","value":0.64285713,"value_description":"0.64","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssigneeTotal=28, closedTasksAssignee=18}\nformula: closedTasksAssignee / tasksAssigneeTotal\nvalue: 0.6428571428571429","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["closedtasks","fulfillmentoftasks"]},{"id":"closedtasks_mariacloehb","name":"mariacloehb closed tasks","description":"Percentage of closed tasks made by a student with respect to the total number of tasks assigned to student","value":0.6666667,"value_description":"0.67","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssigneeTotal=9, closedTasksAssignee=6}\nformula: closedTasksAssignee / tasksAssigneeTotal\nvalue: 0.6666666666666666","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["closedtasks","fulfillmentoftasks"]},{"id":"closedtasks_oriolcuellar","name":"oriolcuellar closed tasks","description":"Percentage of closed tasks made by a student with respect to the total number of tasks assigned to student","value":0.375,"value_description":"0.38","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssigneeTotal=24, closedTasksAssignee=9}\nformula: closedTasksAssignee / tasksAssigneeTotal\nvalue: 0.375","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["closedtasks","fulfillmentoftasks"]},{"id":"closedtasks_pablomartinez34","name":"pablomartinez34 closed tasks","description":"Percentage of closed tasks made by a student with respect to the total number of tasks assigned to student","value":0.9,"value_description":"0.90","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssigneeTotal=20, closedTasksAssignee=18}\nformula: closedTasksAssignee / tasksAssigneeTotal\nvalue: 0.9","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["closedtasks","fulfillmentoftasks"]},{"id":"closedtasks_sergicasau","name":"sergicasau closed tasks","description":"Percentage of closed tasks made by a student with respect to the total number of tasks assigned to student","value":0.75,"value_description":"0.75","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksAssigneeTotal=8, closedTasksAssignee=6}\nformula: closedTasksAssignee / tasksAssigneeTotal\nvalue: 0.75","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["closedtasks","fulfillmentoftasks"]},{"id":"commits_K4meshi","name":"K4meshi commits","description":"Percentage of commits made by a student with respect to the total number of commits in the project","value":0.04761905,"value_description":"0.05","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTotal=126, commitAssignee=6}\nformula: commitAssignee / commitsTotal\nvalue: 0.047619047619047616","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitscontribution"]},{"id":"commits_anonymous","name":"'Anonymous' commits","description":"Percentage of commits made by an unknown author with respect to all commits in the project","value":0.18709677,"value_description":"0.19","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitAnonymous=29, commitsAll=155}\nformula: commitAnonymous / commitsAll\nvalue: 0.1870967741935484","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitsmanagement"]},{"id":"commits_gerardalvarez","name":"gerardalvarez commits","description":"Percentage of commits made by a student with respect to the total number of commits in the project","value":0.2936508,"value_description":"0.29","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTotal=126, commitAssignee=37}\nformula: commitAssignee / commitsTotal\nvalue: 0.29365079365079366","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitscontribution"]},{"id":"commits_mariacloehb","name":"mariacloehb commits","description":"Percentage of commits made by a student with respect to the total number of commits in the project","value":0.03968254,"value_description":"0.04","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTotal=126, commitAssignee=5}\nformula: commitAssignee / commitsTotal\nvalue: 0.03968253968253968","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitscontribution"]},{"id":"commits_oriolcuellar","name":"oriolcuellar commits","description":"Percentage of commits made by a student with respect to the total number of commits in the project","value":0.0952381,"value_description":"0.10","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTotal=126, commitAssignee=12}\nformula: commitAssignee / commitsTotal\nvalue: 0.09523809523809523","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitscontribution"]},{"id":"commits_pablomartinezceldran","name":"pablomartinezceldran commits","description":"Percentage of commits made by a student with respect to the total number of commits in the project","value":0.3968254,"value_description":"0.40","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTotal=126, commitAssignee=50}\nformula: commitAssignee / commitsTotal\nvalue: 0.3968253968253968","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitscontribution"]},{"id":"commits_sd","name":"Commits Standard Deviation","description":"","value":0.13296118,"value_description":"0.13","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsgerardalvarez=37, commitssergicasau19=16, commitsoriolcuellar=12, commitsK4meshi=6, commitsmariacloehb=5, commitsTotal=126, commitspablomartinezceldran=50}\nformula: sqrt ( ( ( ( ( commitsK4meshi / commitsTotal ) - ( ( commitsK4meshi / commitsTotal + commitsgerardalvarez / commitsTotal + commitsmariacloehb / commitsTotal + commitsoriolcuellar / commitsTotal + commitspablomartinezceldran / commitsTotal + commitssergicasau19 / commitsTotal ) / 6 ) ) ^ 2 ) + ( ( ( commitsgerardalvarez / commitsTotal ) - ( ( commitsK4meshi / commitsTotal + commitsgerardalvarez / commitsTotal + commitsmariacloehb / commitsTotal + commitsoriolcuellar / commitsTotal + commitspablomartinezceldran / commitsTotal + commitssergicasau19 / commitsTotal ) / 6 ) ) ^ 2 ) + ( ( ( commitsmariacloehb / commitsTotal ) - ( ( commitsK4meshi / commitsTotal + commitsgerardalvarez / commitsTotal + commitsmariacloehb / commitsTotal + commitsoriolcuellar / commitsTotal + commitspablomartinezceldran / commitsTotal + commitssergicasau19 / commitsTotal ) / 6 ) ) ^ 2 ) + ( ( ( commitsoriolcuellar / commitsTotal ) - ( ( commitsK4meshi / commitsTotal + commitsgerardalvarez / commitsTotal + commitsmariacloehb / commitsTotal + commitsoriolcuellar / commitsTotal + commitspablomartinezceldran / commitsTotal + commitssergicasau19 / commitsTotal ) / 6 ) ) ^ 2 ) + ( ( ( commitspablomartinezceldran / commitsTotal ) - ( ( commitsK4meshi / commitsTotal + commitsgerardalvarez / commitsTotal + commitsmariacloehb / commitsTotal + commitsoriolcuellar / commitsTotal + commitspablomartinezceldran / commitsTotal + commitssergicasau19 / commitsTotal ) / 6 ) ) ^ 2 ) + ( ( ( commitssergicasau19 / commitsTotal ) - ( ( commitsK4meshi / commitsTotal + commitsgerardalvarez / commitsTotal + commitsmariacloehb / commitsTotal + commitsoriolcuellar / commitsTotal + commitspablomartinezceldran / commitsTotal + commitssergicasau19 / commitsTotal) / 6 ) ) ^ 2 ) ) / 6 )\nvalue: 0.13296118384263558","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["globalstandarddeviation","deviationmetrics"]},{"id":"commits_sergicasau19","name":"sergicasau19 commits","description":"Percentage of commits made by a student with respect to the total number of commits in the project","value":0.12698413,"value_description":"0.13","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTotal=126, commitAssignee=16}\nformula: commitAssignee / commitsTotal\nvalue: 0.12698412698412698","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commits","commitscontribution"]},{"id":"commits_taskreference","name":"Commits Tasks Relation","description":"Percentage of commits with tasks references with respect to the total number of commits in the project","value":0.0,"value_description":"0.00","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {commitsTaskReference=0, commitsTotal=126}\nformula: commitsTaskReference / commitsTotal\nvalue: 0.0","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["commitsdescription","commitstasksrelation"]},{"id":"deviation_effort_estimation_simple","name":"Deviation in Estimation of Task Effort","description":"Percentage of closed tasks with more than +-25% of deviation in the task effort estimation in this sprint","value":0.0,"value_description":"0.00","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {threshold=25}\nexecutionResults: {highDeviatedTasks=0, ClosedTasksWithEffortTotal=0}\nformula: highDeviatedTasks / ClosedTasksWithEffortTotal\nvalue: NaN","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["deviationmetrics"]},{"id":"modifiedlines_K4meshi","name":"K4meshi modified lines","description":"Percentage of modified lines of code made by a student with respect to the total number of modified lines of code in the project","value":0.05604591,"value_description":"0.06","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {nCommitAssignee=5264.0, nCommitsTotal=93923.0}\nformula: nCommitAssignee / nCommitsTotal\nvalue: 0.05604590994751019","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["modifiedlinescontribution"]},{"id":"modifiedlines_gerardalvarez","name":"gerardalvarez modified lines","description":"Percentage of modified lines of code made by a student with respect to the total number of modified lines of code in the project","value":0.59014297,"value_description":"0.59","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {nCommitAssignee=55428.0, nCommitsTotal=93923.0}\nformula: nCommitAssignee / nCommitsTotal\nvalue: 0.5901429894700978","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["modifiedlinescontribution"]},{"id":"modifiedlines_mariacloehb","name":"mariacloehb modified lines","description":"Percentage of modified lines of code made by a student with respect to the total number of modified lines of code in the project","value":0.21594284,"value_description":"0.22","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {nCommitAssignee=20282.0, nCommitsTotal=93923.0}\nformula: nCommitAssignee / nCommitsTotal\nvalue: 0.21594284680003833","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["modifiedlinescontribution"]},{"id":"modifiedlines_oriolcuellar","name":"oriolcuellar modified lines","description":"Percentage of modified lines of code made by a student with respect to the total number of modified lines of code in the project","value":0.009912375,"value_description":"0.01","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {nCommitAssignee=931.0, nCommitsTotal=93923.0}\nformula: nCommitAssignee / nCommitsTotal\nvalue: 0.00991237503061018","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["modifiedlinescontribution"]},{"id":"modifiedlines_pablomartinezceldran","name":"pablomartinezceldran modified lines","description":"Percentage of modified lines of code made by a student with respect to the total number of modified lines of code in the project","value":0.061635595,"value_description":"0.06","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {nCommitAssignee=5789.0, nCommitsTotal=93923.0}\nformula: nCommitAssignee / nCommitsTotal\nvalue: 0.06163559511514752","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["modifiedlinescontribution"]},{"id":"modifiedlines_sergicasau19","name":"sergicasau19 modified lines","description":"Percentage of modified lines of code made by a student with respect to the total number of modified lines of code in the project","value":0.066320285,"value_description":"0.07","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {nCommitAssignee=6229.0, nCommitsTotal=93923.0}\nformula: nCommitAssignee / nCommitsTotal\nvalue: 0.06632028363659594","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["modifiedlinescontribution"]},{"id":"pattern_check","name":"Use of User Story pattern","description":"Percentage of user stories with the pattern (AS - I WANT - SO THAT - ) with respect to the total number of user stories in this sprint","value":0.70454544,"value_description":"0.70","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {userStoriesWithPattern=31, userStoriesTotal=44}\nformula: userStoriesWithPattern / userStoriesTotal\nvalue: 0.7045454545454546","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["userstoriesdefinitionquality"]},{"id":"tasks_sd","name":"Tasks Standard Deviation","description":"","value":0.19891925,"value_description":"0.20","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {taskspablomartinez34=20, taskssergicasau=8, tasksgerardalvarez=28, tasksoriolcuellar=24, tasksmariacloehb=9, tasksAkram_T=7, tasksTotal=96}\nformula: sqrt ( ( ( ( ( tasksAkram_T / tasksTotal ) - ( ( tasksAkram_T / tasksTotal + tasksgerardalvarez / tasksTotal + tasksmariacloehb / tasksTotal + tasksoriolcuellar / tasksTotal + taskspablomartinez34 / tasksTotal + taskssergicasau / tasksTotal ) / 6 ) ) ^ 2 ) + ( ( ( tasksgerardalvarez / tasksTotal ) - ( ( tasksAkram_T / tasksTotal + tasksgerardalvarez / tasksTotal + tasksmariacloehb / tasksTotal + tasksoriolcuellar / tasksTotal + taskspablomartinez34 / tasksTotal + taskssergicasau / tasksTotal ) / 6 ) ) ^ 2 ) + ( ( ( tasksmariacloehb / tasksTotal ) - ( ( tasksAkram_T / tasksTotal + tasksgerardalvarez / tasksTotal + tasksmariacloehb / tasksTotal + tasksoriolcuellar / tasksTotal + taskspablomartinez34 / tasksTotal + taskssergicasau / tasksTotal ) / 6 ) ) ^ 2 ) + ( ( ( tasksoriolcuellar / tasksTotal ) - ( ( tasksAkram_T / tasksTotal + tasksgerardalvarez / tasksTotal + tasksmariacloehb / tasksTotal + tasksoriolcuellar / tasksTotal + taskspablomartinez34 / tasksTotal + taskssergicasau / tasksTotal ) / 6 ) ) ^ 2 ) + ( ( ( taskspablomartinez34 / tasksTotal ) - ( ( tasksAkram_T / tasksTotal + tasksgerardalvarez / tasksTotal + tasksmariacloehb / tasksTotal + tasksoriolcuellar / tasksTotal + taskspablomartinez34 / tasksTotal + taskssergicasau / tasksTotal ) / 6 ) ) ^ 2 ) + ( ( ( taskssergicasau / tasksTotal ) - ( ( tasksAkram_T / tasksTotal + tasksgerardalvarez / tasksTotal + tasksmariacloehb / tasksTotal + tasksoriolcuellar / tasksTotal + taskspablomartinez34 / tasksTotal + taskssergicasau / tasksTotal ) / 6 ) ) ^ 2 )  / 6 )\nvalue: 0.1989192442694792","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["globalstandarddeviation","deviationmetrics"]},{"id":"tasks_with_EE","name":"Tasks with Estimated Effort Information","description":"Percentage of tasks with estimated effort information added with respect to the total number of tasks in this sprint","value":0.0,"value_description":"0.00","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksWithEstimatedEffort=0, tasksTotal=90}\nformula: tasksWithEstimatedEffort / tasksTotal\nvalue: 0.0","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["taskseffortinformation"]},{"id":"unassignedtasks","name":"Unassigned tasks","description":"Percentage of tasks without assignee with respect to the total number of tasks in this sprint","value":0.18888889,"value_description":"0.19","date":"2022-12-20","datasource":null,"rationale":"parameters: {evaluationDate=2022-12-20}\nquery-properties: {}\nexecutionResults: {tasksUnassigned=17, tasksTotal=90}\nformula: tasksUnassigned / tasksTotal\nvalue: 0.18888888888888888","confidence80":null,"confidence95":null,"forecastingError":null,"qualityFactors":["unassignedtasks"]}];

function getMetrics() {

  http.request('http://gessi-dashboard.essi.upc.edu:8888/api/metrics/current?prj=s11a', (res) => {
    let data = ''
     
    res.on('data', (chunk) => {
        data += chunk;
    });
    
    // Ending the response 
    res.on('end', () => {
        console.log(JSON.parse(data));
        metrics = JSON.parse(data)
    });
       
  }).on("error", (err) => {
    console.log("Error: ", err)
  }).end();
}


//s'executa cada dia a les 02:00AM
cron.schedule("0 2 * * *", function () {
  console.log("---------------------");
  console.log("running a task every day at 02:00 AM");
  getMetrics();
  //si la crida falla fer un altre cron al cap de 6 hores per exemple
  console.log("---------------------");
});


function isLoggedIn(req, res, next) {
  req.user ? next() : res.status(401).send();
}

//GET base
app.get('/', function(req, res) {
  res.render('index.html');
});

app.get('/auth/google',
  passport.authenticate('google', { scope: ['email', 'profile'] })
);

app.get('/google/callback',
  passport.authenticate('google', {
    successRedirect: '/protected',
    failureRedirect: '/auth/failure'
  })
);

app.get('auth/failure', (req, res) => {
  res.send('something went wrong with the authentication...');
})

app.get('/protected', isLoggedIn, (req, res) => {
  res.send(`Hello ${req.user.displayName}, you can now close this window`);
});

app.get('/logout', function(req, res, next) {
  req.logout(function(err) {
    if (err) { return next(err); }
    req.session.destroy();
    res.send("Goodbye!");
  });
});


//GET metrics
app.get('/metrics', isLoggedIn, (req, res) => {
  res.send(metrics);
});

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
 console.log("El servidor está inicializado en el puerto", PORT);
});